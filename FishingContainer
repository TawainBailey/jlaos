-- Fishing Containerv3
-- This file contains all UI elements for the Fishing tab (ExtractTab)
-- Includes: Auto Fish, Event Fishing, Favorite, and Sell sections

return function(config)
	-- Extract all dependencies from config
	local ExtractTab = config.ExtractTab
	local Notifier = config.Notifier
	
	-- Functions
	local StartLegitAutoFish = config.StartLegitAutoFish
	local StopLegitAutoFish = config.StopLegitAutoFish
	local startAutoEquipRod = config.startAutoEquipRod
	local stopAutoEquipRod = config.stopAutoEquipRod
	local StartStandaloneAutoClickMinigame = config.StartStandaloneAutoClickMinigame
	local StopStandaloneAutoClickMinigame = config.StopStandaloneAutoClickMinigame
	local startEventTeleport = config.startEventTeleport
	local stopEventTeleport = config.stopEventTeleport
	local startAutoFavorite = config.startAutoFavorite
	local stopAutoFavorite = config.stopAutoFavorite
	local startAutoUnfavorite = config.startAutoUnfavorite
	local stopAutoUnfavorite = config.stopAutoUnfavorite
	local unfavoriteAllFish = config.unfavoriteAllFish
	local startAutoSell = config.startAutoSell
	local stopAutoSell = config.stopAutoSell
	local sellAllItems = config.sellAllItems
	
	-- Setters for state variables
	local setLegitDelay = config.setLegitDelay
	local setShakeDelay = config.setShakeDelay
	local setAutoEquipRodEnabled = config.setAutoEquipRodEnabled
	local setAutoClickMinigameEnabled = config.setAutoClickMinigameEnabled
	local setSelectedEvents = config.setSelectedEvents
	local setPrioritizedEvent = config.setPrioritizedEvent
	local setEventTeleportEnabled = config.setEventTeleportEnabled
	local setAutoFavoriteEnabled = config.setAutoFavoriteEnabled
	local setAutoUnfavoriteEnabled = config.setAutoUnfavoriteEnabled
	local setSelectedFishNames = config.setSelectedFishNames
	local setSelectedRarity = config.setSelectedRarity
	local setSelectedVariant = config.setSelectedVariant
	local setAutoSellEnabled = config.setAutoSellEnabled
	local setSellThreshold = config.setSellThreshold
	
	-- Getters
	local getSelectedEvents = config.getSelectedEvents
	local getPrioritizedEvent = config.getPrioritizedEvent
	local getSellThreshold = config.getSellThreshold
	
	-- Fishing Tab Sections
	local FishingSection = ExtractTab:DrawSection({
		Name = "Auto Fish"
	});

	FishingSection:AddToggle({
		Name = "Legit Auto Fish",
		Default = false,
		Callback = function(Value)
			if Value then
				StartLegitAutoFish()
				Notifier.new({
					Title = "Legit Auto Fish",
					Content = "Legit auto fish enabled",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				StopLegitAutoFish()
				Notifier.new({
					Title = "Legit Auto Fish",
					Content = "Legit auto fish disabled",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	FishingSection:AddToggle({
		Name = "Auto Equip Rod",
		Default = false,
		Callback = function(Value)
			setAutoEquipRodEnabled(Value)
			
			if Value then
				startAutoEquipRod()
				Notifier.new({
					Title = "Auto Equip Rod",
					Content = "Auto Equip Rod",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				stopAutoEquipRod()
				Notifier.new({
					Title = "Auto Equip Rod",
					Content = "Auto Equip Rod",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	FishingSection:AddToggle({
		Name = "Auto Click Minigame",
		Default = false,
		Callback = function(Value)
			if Value then
				setAutoClickMinigameEnabled(true)
				StartStandaloneAutoClickMinigame()
				Notifier.new({
					Title = "Auto Click Minigame",
					Content = "Auto Click Minigame enabled",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				StopStandaloneAutoClickMinigame()
				Notifier.new({
					Title = "Auto Click Minigame",
					Content = "Auto Click Minigame disabled",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	FishingSection:AddTextBox({
		Name = "Legit Delay",
		Default = "1.1",
		Placeholder = "0-10 seconds",
		Callback = function(Text)
			local value = tonumber(Text)
			if value and value >= 0 and value <= 10 then
				setLegitDelay(value)
			end
		end,
	});

	FishingSection:AddTextBox({
		Name = "MiniGame Delay", 
		Default = "0.1",
		Placeholder = "0+ seconds",
		Callback = function(Text)
			local value = tonumber(Text)
			if value and value >= 0 then
				setShakeDelay(value)
			end
		end,
	});

	-- UnStuck Variables
	local unstuckEnabled = false
	local unstuckConnection = nil
	local originalPosition = nil
	local wasRodEquipped = false
	local lastMinigameStart = 0
	local maxMinigameTime = 30 -- 30 seconds max for minigame

	local function checkIfStuck()
		if not unstuckEnabled then return end
		
		local player = config.player
		local character = player.Character
		if not character or not character:FindFirstChild("HumanoidRootPart") then return end
		
		-- Check if player is in a minigame
		local isInMinigame = false
		if config.FishingController then
			pcall(function()
				if config.FishingController:GetCurrentGUID() then
					isInMinigame = true
				end
			end)
		end
		
		local currentTime = tick()
		
		if isInMinigame then
			if lastMinigameStart == 0 then
				lastMinigameStart = currentTime
			elseif currentTime - lastMinigameStart > maxMinigameTime then
				-- Player is stuck! Reset character
				Notifier.new({
					Title = "UnStuck Activated!",
					Content = "Detected stuck minigame, resetting character...",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				})
				
				-- Store current position if not already stored
				if not originalPosition then
					originalPosition = character.HumanoidRootPart.CFrame
				end
				
				-- Check if rod was equipped
				local replion = config.replion
				if replion then
					pcall(function()
						local equippedType = replion:GetExpect("EquippedType")
						wasRodEquipped = (equippedType == "Fishing Rods")
					end)
				end
				
				-- Reset character
				local humanoid = character:FindFirstChild("Humanoid")
				if humanoid then
					humanoid.Health = 0
				end
				
				-- Wait for respawn and teleport back
				task.wait(2) -- Wait for respawn
				
				local newCharacter = player.Character
				if newCharacter and newCharacter:FindFirstChild("HumanoidRootPart") and originalPosition then
					task.wait(1) -- Wait for character to load
					newCharacter.HumanoidRootPart.CFrame = originalPosition
					
					-- Re-equip rod if it was equipped
					if wasRodEquipped then
						task.wait(0.5)
						pcall(function()
							config.REEquipToolFromHotbar:FireServer(1)
						end)
					end
					
					Notifier.new({
						Title = "UnStuck Complete",
						Content = "Teleported back to original location",
						Duration = 3,
						Icon = "rbxassetid://124426992222665"
					})
				end
				
				lastMinigameStart = 0
			end
		else
			-- Not in minigame, reset timer
			lastMinigameStart = 0
		end
	end

	local function startUnstuckMonitor()
		if unstuckConnection then
			unstuckConnection:Disconnect()
		end
		
		unstuckConnection = config.RunService.Heartbeat:Connect(function()
			checkIfStuck()
		end)
	end

	local function stopUnstuckMonitor()
		if unstuckConnection then
			unstuckConnection:Disconnect()
			unstuckConnection = nil
		end
		lastMinigameStart = 0
		originalPosition = nil
		wasRodEquipped = false
	end

	FishingSection:AddToggle({
		Name = "UnStuck",
		Default = false,
		Callback = function(Value)
			unstuckEnabled = Value
			
			if Value then
				startUnstuckMonitor()
				Notifier.new({
					Title = "UnStuck Enabled",
					Content = "Will reset character if stuck in minigame >30s",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				stopUnstuckMonitor()
				Notifier.new({
					Title = "UnStuck Disabled",
					Content = "UnStuck monitoring stopped",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	-- Event Fishing Section
	local EventSection = ExtractTab:DrawSection({
		Name = "Event Fishing"
	});

	local EventDropdown = EventSection:AddDropdown({
		Name = "Select Events",
		Default = {},
		Multi = true,
		Values = {"Ghost Shark Hunt", "Megalodon Hunt", "Shark Hunt"},
		Callback = function(Value)
			setSelectedEvents(Value)
		end,
	});

	EventSection:AddButton({
		Name = "Clear Events",
		Callback = function()
			setSelectedEvents({})
			if EventDropdown and EventDropdown.SetValue then
				EventDropdown:SetValue({})
			end
			Notifier.new({
				Title = "Cleared",
				Content = "Event selection cleared",
				Duration = 2,
				Icon = "rbxassetid://124426992222665"
			});
		end,
	});

	local PrioritizeDropdown = EventSection:AddDropdown({
		Name = "Prioritize Event",
		Default = "Ghost Shark Hunt",
		Values = {"Ghost Shark Hunt", "Megalodon Hunt", "Shark Hunt"},
		Callback = function(Value)
			setPrioritizedEvent(Value)
		end,
	});

	EventSection:AddButton({
		Name = "Clear Priority",
		Callback = function()
			setPrioritizedEvent(nil)
			if PrioritizeDropdown and PrioritizeDropdown.SetValue then
				PrioritizeDropdown:SetValue(nil)
			end
			Notifier.new({
				Title = "Cleared",
				Content = "Priority event cleared",
				Duration = 2,
				Icon = "rbxassetid://124426992222665"
			});
		end,
	});

	EventSection:AddToggle({
		Name = "Auto Event Teleport",
		Default = false,
		Callback = function(Value)
			setEventTeleportEnabled(Value)
			
			if Value then
				local selectedEvents = getSelectedEvents()
				if not selectedEvents or (type(selectedEvents) == "table" and next(selectedEvents) == nil) then
					Notifier.new({
						Title = "No Events Selected",
						Content = "Please select at least one event",
						Duration = 3,
						Icon = "rbxassetid://124426992222665"
					});
					setEventTeleportEnabled(false)
					return
				end
				
				startEventTeleport()
				Notifier.new({
					Title = "Auto Event Enabled",
					Content = "Will teleport to selected events",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				stopEventTeleport()
				Notifier.new({
					Title = "Auto Event Disabled",
					Content = "Event teleportation stopped",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});
	
	-- Favorite Section
	local FavoriteSection = ExtractTab:DrawSection({
		Name = "Favorite",
	});

	local FishNamesDropdown = FavoriteSection:AddDropdown({
		Name = "Favorite By Name",
		Default = {},
		Multi = true,
		Values = {
			"Abyshorn Fish", "Abyss Seahorse", "Ancient Arapaima", "Ancient Relic Crocodile", "Ancient Whale",
			"Angler Fish", "Armor Catfish", "Arowana", "Ash Basslet", "Astra Damsel", "Axolotl", "Azure Damsel",
			"Baby Pumpkin Shark", "Ballina Angelfish", "Banded Butterfly", "Bandit Angelfish", "Barracuda Fish",
			"Beanie Leedsicheye", "Blackcap Basslet", "Bleekers Damsel", "Blob Fish", "Blob Shark", "Blue Lobster",
			"Blue-Banded Goby", "Blueflame Ray", "Blumato Clownfish", "Boa Angelfish", "Boar Fish", "Bone Whale",
			"Bumblebee Grouper", "Candy Butterfly", "Candy Corn Eel", "Candycane Lobster", "Catfish", "Charmed Tang",
			"Christmas Trophy 2024", "Christmastree Longnose", "Chrome Tuna", "Clownfish", "Coal Tang", "Coney Fish",
			"Conspi Angelfish", "Copperband Butterfly", "Corazon Damsel", "Cow Clownfish", "Crocodile", "Crystal Crab",
			"Crystal Salamander", "Dark Eel", "Dark Pumpkin Appafish", "Dark Tentacle", "Darwin Clownfish", "Dead Fish",
			"Dead Scary Clownfish", "Dead Spooky Koi Fish", "Dead Zombie Shark", "Deep Sea Crab", "Domino Damsel",
			"Dorhey Tang", "Dotted Stingray", "Drippy Tucanare", "Eerie Shark", "Electric Eel", "Elshark Gran Maja",
			"Enchanted Angelfish", "Fade Tang", "Fangtooth", "Festive Goby", "Festive Pufferfish", "Fire Goby",
			"Firecoal Damsel", "Flame Angelfish", "Flat Fish", "Flying Fish", "Frankenstein Longsnapper",
			"Freshwater Piranha", "Frog", "Frostborn Shark", "Gar Fish", "Ghastly Crab", "Ghastly Hermit Crab",
			"Ghost Shark", "Ghost Spiralfish", "Ghost Worm Fish", "Giant Squid", "Gingerbread Clownfish",
			"Gingerbread Shark", "Gingerbread Tang", "Gingerbread Turtle", "Goliath Tiger", "Great Christmas Whale",
			"Great Whale", "Greenbee Grouper", "Hammerhead Mummy", "Hammerhead Shark", "Hawks Turtle", "Hermit Crab",
			"Herring Fish", "Hybodus Shark", "Jellyfish", "Jennifer Dottyback", "Jewel Tang", "Kau Cardinal",
			"King Crab", "King Jelly", "King Mackerel", "Korean Angelfish", "Lake Sturgeon", "Lava Butterfly",
			"Lavafin Tuna", "Lined Cardinal Fish", "Lion Fish", "Lobster", "Lochness Monster", "Loggerhead Turtle",
			"Longnose Butterfly", "Loving Shark", "Luminous Fish", "Magic Tang", "Magma Goby", "Magma Shark",
			"Mammoth Appafish", "Manoai Statue Fish", "Manta Ray", "Maroon Butterfly", "Masked Angelfish",
			"Maze Angelfish", "Megalodon", "Mistletoe Damsel", "Monk Fish", "Monster Shark", "Moorish Idol",
			"Mosasaur Shark", "Mossy Fishlet", "Mossy Vampire Fish", "Narwhal", "Orange Basslet", "Orangy Goby",
			"Orca", "Panther Eel", "Panther Grouper", "Parrot Fish", "Patriot Tang", "Pilot Fish", "Pink Dolphin",
			"Pink Smith Damsel", "Plasma Shark", "Prismy Seahorse", "Pufferfish", "Pumpkin Angler Fish",
			"Pumpkin Butterfly Fish", "Pumpkin Carved Shark", "Pumpkin Hermit Crab", "Pumpkin Jellyfish",
			"Pumpkin Ray", "Pumpkin StoneTurtle", "Pygmy Goby", "Queen Crab", "Racoon Butterfly Fish", "Red Goatfish",
			"Red Snapper", "Reef Chromis", "Robot Kraken", "Rockfish", "Rockform Cardianl", "Runic Wispeye",
			"Sacred Guardian Squid", "Sail Fish", "Sail Tang", "Salmon", "Saw Fish", "Scare", "Scary Clownfish",
			"Scissortail Dartfish", "Sharp One", "Sheepshead Fish", "Shrimp Goby", "Silver Tuna",
			"Skeleton Angler Fish", "Skeleton Fish", "Skeleton Narwhal", "Skunk Tilefish", "Slurpfish Chromis",
			"Spear Guardian", "Specked Butterfly", "Spooky Koi Fish", "Spooky Peafish", "Spotted Lantern Fish",
			"Starfish", "Starjam Tang", "Strawberry Dotty", "Strippled Seahorse", "Sushi Cardinal", "Swordfish",
			"Synodontis", "Talon Serpent", "Temple Spokes Tuna", "Thin Armor Shark", "Thresher Shark",
			"Toxic Jellyfish", "Tricolore Butterfly", "Unicorn Tang", "Vampire Squid", "Vintage Blue Tang",
			"Vintage Damsel", "Viperangler Fish", "Viperfish", "Volcanic Basslet", "Volsail Tang", "Wahoo",
			"Watanabei Angelfish", "Water Snake", "Waveback Fish", "White Clownfish", "White Tang", "Wild Serpent",
			"Witch Fish", "Witch Koi Fish", "Wizard Stingray", "Worm Fish", "Wraithfin Abyssal", "Yello Damselfish",
			"Yellowfin Tuna", "Yellowstate Angelfish", "Zebra Snakehead", "Zombie Megalodon", "Zombie Shark",
			"Zoster Butterfly"
		},
		Callback = function(Value)
			setSelectedFishNames(Value)
		end,
	});

	FavoriteSection:AddButton({
		Name = "Clear Fish Names",
		Callback = function()
			setSelectedFishNames({})
			if FishNamesDropdown and FishNamesDropdown.SetValue then
				FishNamesDropdown:SetValue({})
			end
			Notifier.new({
				Title = "Cleared",
				Content = "Fish names selection cleared",
				Duration = 2,
				Icon = "rbxassetid://124426992222665"
			});
		end,
	});

	local RarityDropdown = FavoriteSection:AddDropdown({
		Name = "Favorite By Rarity",
		Default = {},
		Multi = true,
		Values = {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mythical"},
		Callback = function(Value)
			setSelectedRarity(Value)
		end,
	});

	FavoriteSection:AddButton({
		Name = "Clear Rarity",
		Callback = function()
			setSelectedRarity({})
			if RarityDropdown and RarityDropdown.SetValue then
				RarityDropdown:SetValue({})
			end
			Notifier.new({
				Title = "Cleared",
				Content = "Rarity selection cleared",
				Duration = 2,
				Icon = "rbxassetid://124426992222665"
			});
		end,
	});

	local VariantDropdown = FavoriteSection:AddDropdown({
		Name = "Favorite By Variant",
		Default = {},
		Multi = true,
		Values = {
			"Albino", "Corrupt", "Fairy Dust", "Festive", "Frozen", "Galaxy",
			"Gemstone", "Ghost", "Gold", "Holographic", "Lightning",
			"Midnight", "Radioactive", "Stone"
		},
		Callback = function(Value)
			setSelectedVariant(Value)
		end,
	});

	FavoriteSection:AddButton({
		Name = "Clear Variant",
		Callback = function()
			setSelectedVariant({})
			if VariantDropdown and VariantDropdown.SetValue then
				VariantDropdown:SetValue({})
			end
			Notifier.new({
				Title = "Cleared",
				Content = "Variant selection cleared",
				Duration = 2,
				Icon = "rbxassetid://124426992222665"
			});
		end,
	});

	FavoriteSection:AddToggle({
		Name = "Auto Favorite",
		Default = false,
		Callback = function(Value)
			setAutoFavoriteEnabled(Value)
			
			if Value then
				startAutoFavorite()
				Notifier.new({
					Title = "Auto Favorite Enabled",
					Content = "Will auto-favorite matching fish",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				stopAutoFavorite()
				Notifier.new({
					Title = "Auto Favorite Disabled",
					Content = "Auto favorite turned off",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	FavoriteSection:AddToggle({
		Name = "Auto Unfavorite",
		Default = false,
		Callback = function(Value)
			setAutoUnfavoriteEnabled(Value)
			
			if Value then
				startAutoUnfavorite()
				Notifier.new({
					Title = "Auto Unfavorite Enabled",
					Content = "Will auto-unfavorite matching fish",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				stopAutoUnfavorite()
				Notifier.new({
					Title = "Auto Unfavorite Disabled",
					Content = "Auto unfavorite turned off",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	FavoriteSection:AddButton({
		Name = "Unfavorite All",
		Callback = function()
			unfavoriteAllFish()
		end,
	});

	-- Sell Section
	local SellSection = ExtractTab:DrawSection({
		Name = "Sell",
	});

	SellSection:AddToggle({
		Name = "Auto Sell",
		Default = false,
		Callback = function(Value)
			setAutoSellEnabled(Value)
			
			if Value then
				startAutoSell()
				local currentThreshold = getSellThreshold()
				Notifier.new({
					Title = "Auto Sell Enabled",
					Content = "Will auto-sell every " .. currentThreshold .. " seconds",
					Duration = 3,
					Icon = "rbxassetid://124426992222665"
				});
			else
				stopAutoSell()
				Notifier.new({
					Title = "Auto Sell Disabled",
					Content = "Auto sell turned off",
					Duration = 2,
					Icon = "rbxassetid://124426992222665"
				});
			end
		end,
	});

	SellSection:AddTextBox({
		Name = "Sell Timer (seconds)",
		Default = "0",
		Placeholder = "0+ seconds",
		Callback = function(Text)
			local value = tonumber(Text)
			if value and value >= 0 then
				setSellThreshold(value)
			end
		end,
	});

	SellSection:AddButton({
		Name = "Sell All",
		Callback = function()
			sellAllItems()
			Notifier.new({
				Title = "Sell All",
				Content = "Sold all items",
				Duration = 2,
				Icon = "rbxassetid://124426992222665"
			});
		end,
	});
end
